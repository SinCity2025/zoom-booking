{% extends 'base.html' %}
{% block content %}
<style>
  /* Ù‚ØµÙ‘ Ù†Øµ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
  .text-trim {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .user-chip {
    font-size: .8rem;
    padding: .25rem .5rem;
    border-radius: .5rem;
  }
</style>

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">

        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
          <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary btn-sm">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª</a>
          <span class="badge bg-secondary">{{ users|length }} :Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
        </div>

        <h5 class="mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h5>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for cat, msg in messages %}
              <div class="alert alert-{{cat}}">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {# ===================== Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ù„: ÙƒØ±ÙˆØª ===================== #}
        <div class="d-md-none">
          {% if users %}
            <div class="vstack gap-3">
              {% for u in users %}
              <div class="border rounded-3 p-3 bg-white">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <span class="text-muted small">#{{ u.id }}</span>
                      {% if u.is_admin %}
                        <span class="badge bg-success">Ø£Ø¯Ù…Ù†</span>
                      {% else %}
                        <span class="badge bg-secondary">Ù…Ø³ØªØ®Ø¯Ù…</span>
                      {% endif %}
                    </div>

                    <!-- Ø§Ù„Ø§Ø³Ù… (Ù†Øµ) -->
                    <div class="fw-semibold text-trim" title="{{ u.name }}">{{ u.name }}</div>
                    <div class="text-muted small text-trim" title="{{ u.email }}">{{ u.email }}</div>

                    <!-- ğŸ”¹ ÙÙˆØ±Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… (Ø¬ÙˆØ§Ù„) -->
                    <form class="d-flex gap-2 mt-2" method="post"
                          action="{{ url_for('admin_rename_user', uid=u.id) }}">
                      <!-- {{ csrf_token() }} Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…ÙØ¹Ù‘Ù„ CSRF -->
                      <input class="form-control form-control-sm" name="name"
                             value="{{ u.name }}" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯">
                      <button class="btn btn-sm btn-outline-primary">Ø­ÙØ¸</button>
                    </form>
                  </div>
                </div>

                <div class="d-grid gap-2 mt-3">
                  {% if not u.is_admin %}
                    <form method="post" action="{{ url_for('admin_make_admin', uid=u.id) }}">
                      <!-- {{ csrf_token() }} -->
                      <button class="btn btn-primary btn-sm">ØªØ±Ù‚ÙŠØ© Ù„Ø£Ø¯Ù…Ù†</button>
                    </form>
                  {% else %}
                    <form method="post" action="{{ url_for('admin_remove_admin', uid=u.id) }}">
                      <!-- {{ csrf_token() }} -->
                      <button class="btn btn-outline-warning btn-sm">Ø¥Ù„ØºØ§Ø¡ Ø£Ø¯Ù…Ù†</button>
                    </form>
                  {% endif %}

                  {% if user and user.id != u.id %}
                  <form method="post"
                        action="{{ url_for('admin_delete_user', uid=u.id) }}"
                        onsubmit="return confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ø³ÙŠÙØ­Ø°Ù Ù…Ø¹Ù‡ Ø³Ø¬Ù„ Ø­Ø¬ÙˆØ²Ø§ØªÙ‡.');">
                    <!-- {{ csrf_token() }} -->
                    <button class="btn btn-outline-danger btn-sm">Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                  </form>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ø¹Ø¯.</div>
          {% endif %}
        </div>

        {# ===================== Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨/Ø§Ù„ØªØ§Ø¨Ù„Øª: Ø¬Ø¯ÙˆÙ„ ===================== #}
        <div class="d-none d-md-block">
          {% if users %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th class="text-nowrap">#</th>
                    <th class="text-nowrap">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="text-nowrap">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                    <th class="text-center text-nowrap">Ø£Ø¯Ù…Ù†ØŸ</th>
                    <th class="text-center text-nowrap" style="width:260px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in users %}
                  <tr>
                    <td class="text-muted">{{ u.id }}</td>

                    <!-- ğŸ”¹ ÙÙˆØ±Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… (Ø¯ÙŠØ³ÙƒØªÙˆØ¨) -->
                    <td>
                      <form class="d-flex gap-2" method="post"
                            action="{{ url_for('admin_rename_user', uid=u.id) }}">
                        <!-- {{ csrf_token() }} -->
                        <input class="form-control form-control-sm" style="max-width: 220px"
                               name="name" value="{{ u.name }}" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯">
                        <button class="btn btn-sm btn-outline-primary">Ø­ÙØ¸</button>
                      </form>
                    </td>

                    <td>{{ u.email }}</td>
                    <td class="text-center">
                      {% if u.is_admin %}
                        <span class="badge bg-success">Ù†Ø¹Ù…</span>
                      {% else %}
                        <span class="badge bg-secondary">Ù„Ø§</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm" role="group">
                        {% if not u.is_admin %}
                          <form method="post" action="{{ url_for('admin_make_admin', uid=u.id) }}">
                            <!-- {{ csrf_token() }} -->
                            <button class="btn btn-primary">ØªØ±Ù‚ÙŠØ©</button>
                          </form>
                        {% else %}
                          <form method="post" action="{{ url_for('admin_remove_admin', uid=u.id) }}">
                            <!-- {{ csrf_token() }} -->
                            <button class="btn btn-outline-warning">Ø¥Ù„ØºØ§Ø¡ Ø£Ø¯Ù…Ù†</button>
                          </form>
                        {% endif %}
                        {% if user and user.id != u.id %}
                          <form method="post"
                                action="{{ url_for('admin_delete_user', uid=u.id) }}"
                                onsubmit="return confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ');">
                            <!-- {{ csrf_token() }} -->
                            <button class="btn btn-outline-danger">Ø­Ø°Ù</button>
                          </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ø¹Ø¯.</div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}