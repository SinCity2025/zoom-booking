{% extends 'base.html' %}
{% block content %}
<style>
  /* قصّ نص الاسم/الإيميل داخل الكروت */
  .text-trim {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .user-chip {
    font-size: .8rem;
    padding: .25rem .5rem;
    border-radius: .5rem;
  }
</style>

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">

        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
          <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary btn-sm">الرجوع للحجوزات</a>
          <span class="badge bg-secondary">{{ users|length }} :إجمالي</span>
        </div>

        <h5 class="mb-3">إدارة المستخدمين</h5>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for cat, msg in messages %}
              <div class="alert alert-{{cat}}">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {# ===================== عرض الجوال: كروت ===================== #}
        <div class="d-md-none">
          {% if users %}
            <div class="vstack gap-3">
              {% for u in users %}
              <div class="border rounded-3 p-3 bg-white">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <span class="text-muted small">#{{ u.id }}</span>
                      {% if u.is_admin %}
                        <span class="badge bg-success">أدمن</span>
                      {% else %}
                        <span class="badge bg-secondary">مستخدم</span>
                      {% endif %}
                    </div>

                    <!-- الاسم (نص) -->
                    <div class="fw-semibold text-trim" title="{{ u.name }}">{{ u.name }}</div>
                    <div class="text-muted small text-trim" title="{{ u.email }}">{{ u.email }}</div>

                    <!-- 🔹 فورم تعديل الاسم (جوال) -->
                    <form class="d-flex gap-2 mt-2" method="post"
                          action="{{ url_for('admin_rename_user', uid=u.id) }}">
                      <!-- {{ csrf_token() }} إذا كنت مفعّل CSRF -->
                      <input class="form-control form-control-sm" name="name"
                             value="{{ u.name }}" placeholder="اسم جديد">
                      <button class="btn btn-sm btn-outline-primary">حفظ</button>
                    </form>
                  </div>
                </div>

                <div class="d-grid gap-2 mt-3">
                  {% if not u.is_admin %}
                    <form method="post" action="{{ url_for('admin_make_admin', uid=u.id) }}">
                      <!-- {{ csrf_token() }} -->
                      <button class="btn btn-primary btn-sm">ترقية لأدمن</button>
                    </form>
                  {% else %}
                    <form method="post" action="{{ url_for('admin_remove_admin', uid=u.id) }}">
                      <!-- {{ csrf_token() }} -->
                      <button class="btn btn-outline-warning btn-sm">إلغاء أدمن</button>
                    </form>
                  {% endif %}

                  {% if user and user.id != u.id %}
                  <form method="post"
                        action="{{ url_for('admin_delete_user', uid=u.id) }}"
                        onsubmit="return confirm('متأكد من حذف هذا المستخدم؟ سيُحذف معه سجل حجوزاته.');">
                    <!-- {{ csrf_token() }} -->
                    <button class="btn btn-outline-danger btn-sm">حذف المستخدم</button>
                  </form>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">لا يوجد مستخدمون بعد.</div>
          {% endif %}
        </div>

        {# ===================== عرض الديسكتوب/التابلت: جدول ===================== #}
        <div class="d-none d-md-block">
          {% if users %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th class="text-nowrap">#</th>
                    <th class="text-nowrap">الاسم</th>
                    <th class="text-nowrap">البريد</th>
                    <th class="text-center text-nowrap">أدمن؟</th>
                    <th class="text-center text-nowrap" style="width:260px">إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in users %}
                  <tr>
                    <td class="text-muted">{{ u.id }}</td>

                    <!-- 🔹 فورم تعديل الاسم (ديسكتوب) -->
                    <td>
                      <form class="d-flex gap-2" method="post"
                            action="{{ url_for('admin_rename_user', uid=u.id) }}">
                        <!-- {{ csrf_token() }} -->
                        <input class="form-control form-control-sm" style="max-width: 220px"
                               name="name" value="{{ u.name }}" placeholder="اسم جديد">
                        <button class="btn btn-sm btn-outline-primary">حفظ</button>
                      </form>
                    </td>

                    <td>{{ u.email }}</td>
                    <td class="text-center">
                      {% if u.is_admin %}
                        <span class="badge bg-success">نعم</span>
                      {% else %}
                        <span class="badge bg-secondary">لا</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm" role="group">
                        {% if not u.is_admin %}
                          <form method="post" action="{{ url_for('admin_make_admin', uid=u.id) }}">
                            <!-- {{ csrf_token() }} -->
                            <button class="btn btn-primary">ترقية</button>
                          </form>
                        {% else %}
                          <form method="post" action="{{ url_for('admin_remove_admin', uid=u.id) }}">
                            <!-- {{ csrf_token() }} -->
                            <button class="btn btn-outline-warning">إلغاء أدمن</button>
                          </form>
                        {% endif %}
                        {% if user and user.id != u.id %}
                          <form method="post"
                                action="{{ url_for('admin_delete_user', uid=u.id) }}"
                                onsubmit="return confirm('متأكد من حذف هذا المستخدم؟');">
                            <!-- {{ csrf_token() }} -->
                            <button class="btn btn-outline-danger">حذف</button>
                          </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">لا يوجد مستخدمون بعد.</div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}