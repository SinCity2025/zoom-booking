{% extends 'base.html' %}
{% block content %}
<style>
  .text-trim { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
</style>

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
          <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary btn-sm">الرجوع للحجوزات</a>
          <span class="badge bg-secondary">{{ users|length }} :إجمالي</span>
        </div>

        <h5 class="mb-3">إدارة المستخدمين</h5>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for cat, msg in messages %}
              <div class="alert alert-{{cat}} mb-2">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- موبايل: كروت -->
        <div class="d-md-none">
          {% if users %}
            <div class="vstack gap-3">
              {% for u in users %}
              <div class="border rounded-3 p-3 bg-white">
                <div class="d-flex align-items-start justify-content-between gap-2">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <span class="text-muted small">#{{ u.id }}</span>
                      {% if u.is_admin %}
                        <span class="badge bg-success">أدمن</span>
                      {% else %}
                        <span class="badge bg-secondary">مستخدم</span>
                      {% endif %}
                    </div>
                    <div class="fw-semibold text-trim" title="{{ u.name }}">{{ u.name }}</div>
                    <div class="text-muted small text-trim" title="{{ u.email }}">{{ u.email }}</div>

                    <form class="d-flex gap-2 mt-2" method="post" action="{{ url_for('admin_rename_user', uid=u.id) }}">
                      <input class="form-control form-control-sm" name="name" value="{{ u.name }}" placeholder="اسم جديد" maxlength="120" required>
                      <button class="btn btn-sm btn-outline-primary">حفظ</button>
                    </form>
                  </div>
                </div>

                <div class="d-grid gap-2 mt-3">
                  {% if not u.is_admin %}
                    <form method="post" action="{{ url_for('admin_make_admin', uid=u.id) }}">
                      <button class="btn btn-primary btn-sm">ترقية لأدمن</button>
                    </form>
                  {% else %}
                    <form method="post" action="{{ url_for('admin_remove_admin', uid=u.id) }}">
                      <button class="btn btn-outline-warning btn-sm">إلغاء أدمن</button>
                    </form>
                  {% endif %}

                  {% if user and user.id != u.id %}
                  <form method="post" action="{{ url_for('admin_delete_user', uid=u.id) }}" onsubmit="return confirm('متأكد من حذف هذا المستخدم؟ سيُحذف معه سجل حجوزاته.');">
                    <button class="btn btn-outline-danger btn-sm">حذف المستخدم</button>
                  </form>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">لا يوجد مستخدمون بعد.</div>
          {% endif %}
        </div>

        <!-- ديسكتوب: جدول -->
        <div class="d-none d-md-block">
          {% if users %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>الاسم</th>
                    <th>البريد</th>
                    <th class="text-center">أدمن؟</th>
                    <th class="text-center" style="width:320px">إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in users %}
                  <tr>
                    <td class="text-muted">{{ u.id }}</td>
                    <td class="text-trim" title="{{ u.name }}">
                      <form class="d-flex gap-2" method="post" action="{{ url_for('admin_rename_user', uid=u.id) }}">
                        <input class="form-control form-control-sm" style="max-width:220px" name="name" value="{{ u.name }}" placeholder="اسم جديد" maxlength="120" required>
                        <button class="btn btn-sm btn-outline-primary">حفظ</button>
                      </form>
                    </td>
                    <td class="text-trim" title="{{ u.email }}">{{ u.email }}</td>
                    <td class="text-center">
                      {% if u.is_admin %}
                        <span class="badge bg-success">نعم</span>
                      {% else %}
                        <span class="badge bg-secondary">لا</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="d-flex justify-content-center flex-wrap gap-2">
                        {% if not u.is_admin %}
                          <form method="post" action="{{ url_for('admin_make_admin', uid=u.id) }}">
                            <button class="btn btn-primary btn-sm">ترقية</button>
                          </form>
                        {% else %}
                          <form method="post" action="{{ url_for('admin_remove_admin', uid=u.id) }}">
                            <button class="btn btn-outline-warning btn-sm">إلغاء أدمن</button>
                          </form>
                        {% endif %}
                        {% if user and user.id != u.id %}
                          <form method="post" action="{{ url_for('admin_delete_user', uid=u.id) }}" onsubmit="return confirm('متأكد من حذف هذا المستخدم؟');">
                            <button class="btn btn-outline-danger btn-sm">حذف</button>
                          </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">لا يوجد مستخدمون بعد.</div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}